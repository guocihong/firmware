/*C**************************************************************************
* NAME:   eeprom_drv.c
*----------------------------------------------------------------------------
* RELEASE:      2011.01.13   
* REVISION:     1.0    
*----------------------------------------------------------------------------
* PURPOSE:
*   This file contains the EEPROM read/write driver routines.
*****************************************************************************/


/*_____ I N C L U D E S ____________________________________________________*/
#include <INTRINS.H>
#include <string.h>
#include "config.h"  
#include "lib_mcu\c51_drv.h"         /* c51 driver definition */               
#include "eeprom_drv.h"          


/*F**************************************************************************
* NAME: flash_enable()
*----------------------------------------------------------------------------
* PARAMS:
* return:
*----------------------------------------------------------------------------
* PURPOSE: flash 访问初始设定
*----------------------------------------------------------------------------
* REQUIREMENTS: 
*****************************************************************************/
void flash_enable(void)        
{
  IAP_CONTR = IAPEN_ + WTIME_30MHz;   //允许flash访问，设定等待时间(针对22.1184MHz主频率)
}


/*F**************************************************************************
* NAME: flash_disable()
*----------------------------------------------------------------------------
* PARAMS:
* return:
*----------------------------------------------------------------------------
* PURPOSE: 禁止falsh访问
*----------------------------------------------------------------------------
* REQUIREMENTS: 
*****************************************************************************/
void flash_disable(void)        
{
  IAP_CONTR = 0x00;            //禁止flash访问    
  IAP_CMD = FLASH_CMD_STDBY;   //standy 状态
}


/*F**************************************************************************
* NAME: flash_read()
*----------------------------------------------------------------------------
* PARAMS: 
*         addr : 地址
* return: 所读到的字节值
*----------------------------------------------------------------------------
* PURPOSE: 
*   读指定地址处的一个字节
*----------------------------------------------------------------------------
* NOTE: 大约耗时 2 个时钟
*----------------------------------------------------------------------------
* REQUIREMENTS: 
*****************************************************************************/
Byte flash_read(Uint16 addr)   
{ 
  Byte ret_val;

  IAP_ADDRH = HIGH(addr);
  IAP_ADDRL = LOW(addr);
  IAP_CMD = FLASH_CMD_READ;

  Disable_interrupt();
  FLASH_CMD_TRIG(); 
  _nop_();
  _nop_();
  ret_val = IAP_DATA;
  Enable_interrupt();
  
  return ret_val;
}


/*F**************************************************************************
* NAME: flash_write()
*----------------------------------------------------------------------------
* PARAMS: 
*         val  : 写入的值
*         addr : 地址
* return: None
*----------------------------------------------------------------------------
* PURPOSE: 
*   向指定地址处写入一个字节值	          
*----------------------------------------------------------------------------
* NOTE: 大约耗时 60us
*----------------------------------------------------------------------------
* REQUIREMENTS: 
*****************************************************************************/
void flash_write(Byte val, Uint16 addr)
{ 
  IAP_ADDRH = HIGH(addr);
  IAP_ADDRL = LOW(addr);
  IAP_DATA = val;
  IAP_CMD = FLASH_CMD_WRITE;

  Disable_interrupt();
  FLASH_CMD_TRIG(); 
  _nop_();
  _nop_();
  Enable_interrupt();  
}


/*F**************************************************************************
* NAME: flash_erase()
*----------------------------------------------------------------------------
* PARAMS: 
*         addr : 待擦除扇区的起始地址（该扇区的第一个地址）
* return: None
*----------------------------------------------------------------------------
* PURPOSE: 
*   擦除指定扇区
*----------------------------------------------------------------------------
* NOTE: 大约耗时 21us ?
*****************************************************************************/
void flash_erase(Uint16 addr)
{  
  IAP_ADDRH = HIGH(addr);   
  IAP_ADDRL = LOW(addr);  
  IAP_CMD = FLASH_CMD_ERASE;

  Disable_interrupt();
  FLASH_CMD_TRIG(); 
  _nop_();
  _nop_();
  Enable_interrupt(); 
}
